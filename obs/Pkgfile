# Description: Software for video recording and live streaming
# URL: https://obsproject.com/
# Maintainer: Ola HÃ¥kansson <ola dot hakansson at gmail dot com>
# Depends on: cmake ninja jack v4l-utils ffmpeg mbedtls fdk-aac libgmp qt5 x264 ffnvcodec-headers luajit speexdsp

name=obs-studio
version=27.1.3
release=1
browsercommit=d78acd7d542810909693b4d37ad63e015e7c648e
source=(https://github.com/obsproject/$name/archive/$version.tar.gz
        https://cdn-fastly.obsproject.com/downloads/cef_binary_4280_linux64.tar.bz2
        https://github.com/obsproject/obs-browser/archive/$browsercommit.zip)

build() {

  mkdir build

  rm -rf $SRC/$name-$version/plugins/obs-browser
  mv $SRC/obs-browser-$browsercommit $SRC/$name-$version/plugins/obs-browser

  cmake -GNinja \
    -Wno-dev \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_INSTALL_LIBDIR='/usr/lib' \
    -DCMAKE_BUILD_TYPE=Release \
    -DOBS_VERSION_OVERRIDE="$version" \
    -DUNIX_STRUCTURE=ON \
    -DCOMPILE_LUA=ON \
    -DCOMPILE_PYTHON=ON \
    -DENABLE_SCRIPTING=ON \
    -DDISABLE_UPDATE_MODULE=ON \
    -DENABLE_WAYLAND=OFF \
    -DENABLE_PIPEWIRE=OFF \
    -DBUILD_BROWSER=ON \
    -DCEF_ROOT_DIR=$SRC/cef_binary_4280_linux64 \
    -DBUILD_VST=OFF \
    -S $name-$version -B build

  ninja -C build -j ${JOBS:-1}
  DESTDIR=$PKG ninja -C build install

  rm -r $PKG/usr/share/obs/obs-studio/authors/AUTHORS

  find $PKG/usr/share/obs \
       -iname '*ini' \
       ! -iname 'en-*.ini' \
       ! -iname 'locale.ini' \
       -exec rm '{}' \+
}
